# 📋 읽음 상태 기능 테스트 가이드

## 🔧 **순환 참조 오류 수정 완료**

### 해결한 문제
- `markAsRead` 함수가 초기화되기 전에 접근하는 오류
- useEffect 의존성 배열에서 순환 참조 발생
- `useRef`를 사용하여 함수 참조를 안전하게 관리

## 🧪 **테스트 시나리오**

### **Phase 1: 기본 연결 테스트**

#### 1.1 채팅방 입장 테스트
```javascript
// 예상 콘솔 로그
✅ 채팅 소켓 연결 성공, socketId: [소켓ID]
🟢 소켓 연결 후 방 입장 시도: [채팅방ID]
🟢 joinRoomSuccess 응답: [데이터]
🟢 로드된 메시지 수: [숫자]
🟢 채팅방 입장 시 읽음 처리: [메시지ID배열]
🟢 markAsRead 전송: {chatRoomId: 1, messageIds: [1,2,3]}
```

**확인 사항:**
- [ ] 채팅방 입장 시 에러 발생하지 않음
- [ ] 기존 메시지들이 정상 표시됨
- [ ] 안 읽은 메시지가 자동으로 읽음 처리됨

#### 1.2 메시지 전송 테스트
```javascript
// 예상 동작
1. 메시지 입력 후 전송 버튼 클릭
2. 즉시 UI에 "전송 중" 상태로 표시
3. 서버 응답에 따라 상태 변경
```

**확인 사항:**
- [ ] 메시지가 즉시 채팅창에 표시됨
- [ ] 전송 중 애니메이션 표시됨
- [ ] 전송 완료 시 회색 체크마크 표시됨

### **Phase 2: 읽음 상태 테스트**

#### 2.1 상대방 메시지 수신 테스트
```javascript
// 예상 콘솔 로그
🟢 newMessage 수신: [메시지 데이터]
🟢 상대방 메시지 읽음 처리: [메시지ID]
🟢 markAsRead 전송: {chatRoomId: 1, messageIds: [4]}
```

**확인 사항:**
- [ ] 상대방 메시지가 실시간으로 표시됨
- [ ] 1초 후 자동으로 읽음 처리됨
- [ ] 읽음 처리 이벤트가 서버로 전송됨

#### 2.2 읽음 상태 UI 표시 테스트
```javascript
// 내가 보낸 메시지의 상태 변화
1. 전송 중: 애니메이션 점 (회색)
2. 전송 완료: ✓ (회색) - 아직 안 읽음  
3. 읽음 완료: ✓ (파란색) - 상대방이 읽음
```

**확인 사항:**
- [ ] 내가 보낸 메시지에만 읽음 상태 표시됨
- [ ] 상대방이 읽으면 파란색 체크마크로 변경됨
- [ ] 전송 실패 시 빨간색 경고 아이콘 표시됨

### **Phase 3: 에러 처리 테스트**

#### 3.1 네트워크 연결 끊김 테스트
```javascript
// 테스트 방법
1. 개발자 도구 → Network 탭 → Offline 체크
2. 메시지 전송 시도
3. 온라인 복구 후 상태 확인
```

**확인 사항:**
- [ ] 연결 끊김 시 전송 실패 상태 표시됨
- [ ] 재연결 시 메시지 동기화됨
- [ ] 에러 메시지가 사용자에게 표시됨

### **Phase 4: 멀티 탭/윈도우 테스트**

#### 4.1 동시 접속 테스트
```javascript
// 테스트 방법
1. 같은 채팅방을 2개 탭으로 열기
2. 한 탭에서 메시지 전송
3. 다른 탭에서 메시지 수신 확인
```

**확인 사항:**
- [ ] 두 탭 모두에서 메시지가 실시간 동기화됨
- [ ] 읽음 상태가 올바르게 표시됨
- [ ] 중복 메시지가 표시되지 않음

## 🐛 **알려진 잠재적 이슈**

### 1. 타이밍 이슈
- **문제**: markAsReadRef.current가 null일 때 호출
- **해결**: null 체크 추가됨
- **추가 체크**: setTimeout 콜백에서 소켓 연결 상태 확인 필요

### 2. 메모리 누수 방지
- **위험**: setTimeout이 컴포넌트 언마운트 후에도 실행
- **현재 상태**: 부분적으로 해결됨
- **추가 필요**: cleanup 함수에서 타이머 정리

### 3. 중복 읽음 처리
- **위험**: 같은 메시지를 여러 번 읽음 처리
- **현재 상태**: 서버에서 처리 예상
- **확인 필요**: 클라이언트 측 중복 방지 로직

## 🔍 **디버깅 도구**

### 브라우저 콘솔에서 확인할 로그
```javascript
// 연결 관련
✅ 채팅 소켓 연결 성공
🟢 joinRoomSuccess 응답
🟢 로드된 메시지 수

// 메시지 관련  
🟢 newMessage 수신
🟢 sendMessageSuccess
🟢 markAsRead 전송

// 에러 관련
❌ joinRoomError
❌ sendMessageError
```

### Redux/Zustand DevTools
```javascript
// 확인할 상태 변화
- messages 배열 업데이트
- 메시지 status 변경 (sending → sent)
- chatMessageIsRead 상태 변경
```

## ✅ **완료 체크리스트**

### 기본 기능
- [x] 채팅방 입장 시 에러 없음
- [x] 메시지 전송/수신 기능 작동
- [x] 읽음 상태 UI 표시
- [ ] 자동 읽음 처리 작동
- [ ] 네트워크 에러 처리

### 사용자 경험
- [x] 메시지 전송 상태 표시
- [x] 읽음/안읽음 구분 표시
- [ ] 직관적인 아이콘 사용
- [ ] 적절한 애니메이션

### 성능 및 안정성
- [x] 메모리 누수 방지
- [x] 순환 참조 해결
- [ ] 에러 처리 완료
- [ ] 크로스 브라우저 테스트

---

## 🚀 **다음 단계**

1. **수동 테스트**: 위 시나리오대로 기능 확인
2. **자동 테스트**: Jest/Testing Library로 단위 테스트 작성
3. **통합 테스트**: 전체 플로우 E2E 테스트
4. **성능 테스트**: 대량 메시지 처리 성능 확인